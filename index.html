<!doctype html>
<html lang="ko">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="프로세스 스케줄러 시뮬레이터">
    <meta name="theme-color" content="#bb88ff">
    <title>thanOS 프로세스 스케줄러</title>

    <!-- jQuery 3.3.1 -->
    <script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
    <!-- Bootstrap 3.3.7 -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.0/js/bootstrap.min.js"></script>

    <link rel="stylesheet" href="css/main.css">
    <script src="js/execute.js"></script>
    <script src="js/funcs.js"></script>

</head>

<body>

<div class="container">

    <div class="row">
        <!-- 1열: 입력 폼 -->
        <div class="col-md-6 col-md-offset-3 col-input">
            <div class="panel panel-default">
                <div class="panel-body">
                    <h1>thanOS</h1>
                    <h2>프로세스 스케줄러</h2>
                    <!--[if IE]>
                    <p class="center"><strong>오래된</strong> 브라우저를 사용하고 계시네요. 브라우저를 <a href="https://browsehappy.com/">업데이트</a>해 주세요.</p>
                    <![endif]-->
                </div>
            </div>
            <form class="form">
                <div class="panel panel-default">
                    <div class="panel-body">
                        <div class="form-group" id="group-technique">
                            <label class="radio control-label big">스케줄링 기법</label>
                            <div class="radio-inline">
                                <label>
                                    <input type="radio" name="technique" value="FCFS" required>
                                    <abbr title="First-Come First-Served">FCFS</abbr>
                                </label>
                            </div>
                            <div class="radio-inline">
                                <label>
                                    <input type="radio" name="technique" value="RR" required>
                                    <abbr title="Round Robin">RR</abbr>
                                </label>
                            </div>
                            <div class="radio-inline">
                                <label>
                                    <input type="radio" name="technique" value="SPN" required>
                                    <abbr title="Shortest Process Next">SPN</abbr>
                                </label>
                            </div>
                            <div class="radio-inline">
                                <label>
                                    <input type="radio" name="technique" value="SRTN" required>
                                    <abbr title="Shortest Remaining Time Next">SRTN</abbr>
                                </label>
                            </div>
                            <div class="radio-inline">
                                <label>
                                    <input type="radio" name="technique" value="HRRN" required>
                                    <abbr title="Highest Response Ratio Next">HRRN</abbr>
                                </label>
                            </div>
                            <div class="radio-inline">
                                <label>
                                    <input type="radio" name="technique" value="INFINITY GAUNTLET" required>
                                    <abbr class="sans" title="다뿌셔">INFINITY GAUNTLET</abbr>
                                </label>
                            </div>
                        </div>
                        <!-- RR 선택 시 이 위치에 시간 단위 입력 칸 생성 -->
                        <div class="form-group">
                            <label class="big">프로세스</label>
                            <div class="panel panel-default" id="process-panel-1">
                                <div class="panel-body">
                                    <label for="process-1">P1</label>
                                    <div class="form-inline" id="process-1">
                                        <label for="arrival-1">도착 시간</label>
                                        <input type="number" min="0" class="form-control" id="arrival-1" required>
                                        <br />
                                        <label for="burst-1">수행 시간</label>
                                        <input type="number" min="1" class="form-control" id="burst-1" required>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="form-group right">
                            <!-- 프로세스 추가 시 이 위치에 삭제 버튼 생성 -->
                            <button type="button" class="btn btn-primary" id="add-process"><span class="glyphicon glyphicon-plus"></span> 추가</button>
                        </div>
                    </div>
                </div>

                <div class="panel panel-default">
                    <div class="panel-body">
                        <button type="submit" class="big btn btn-primary btn-block" id="btn-run"><span class="glyphicon glyphicon-play"></span> 실행</button>
                    </div>
                </div>
            </form>
        </div>

        <!-- 2열: 출력 파트 -->
        <div class="col-md-6 col-output" id="out-form" style="opacity: 0;">
            <div class="panel panel-default">
                <div class="panel-body">
                    <h2 id="out-title">안녕하살법</h2>

                    <h3>프로세서</h3>

                    <div class="progress" id ="progress-time" style="height: auto;"></div>

                    <div class="progress" id ="progress-body"></div>
                </div>

                <table class="table table-bordered table-hover">
                    <tr class="active">
                        <th>프로세스</th><th>AT</th><th>BT</th><th>WT</th><th>TT</th><th>NTT</th>
                    </tr>
                    <tbody id="process-table"></tbody>
                </table>
            </div>

            <div class="panel panel-default">
                <div class="panel-body" id="panel-process"></div>
            </div>
        </div>
    </div>

    <!-- Bootstrap 3.3.7 -->
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>

    <script type="text/javascript">
        $(function() {  // 페이지 로드 완료 후 스크립트 로드

            let isRR = false;
            let cntProcess = 1;
            let isRunning = false;

            // 프로세스 기법 라디오 버튼 이벤트
            $('input[type=radio][name=technique]').change(() => {
                let technique = $('input[type=radio][name=technique]:checked').val();
                if (technique === 'RR' && !isRR) {
                    isRR = true;
                    $('#group-technique').after(`
                        <div class="form-inline" id="delta">
                            <label for="delta">δ (Time Quantum)</label>
                            <input type="number" min="1" class="form-control" id="delta" required>
                        </div>
                    `);
                }
                else if (isRR) {
                    isRR = false;
                    $('#delta').remove();
                    $('#quantum').remove();
                }
            });


            // 프로세스 추가 버튼 이벤트
            $('#add-process').click(() => {
                if (cntProcess === 1) {
                    $('#add-process').before(`
          <button type="button" class="btn btn-primary" id="remove-process"><span class="glyphicon glyphicon-minus"></span> 삭제</button>
        `);
                    // 프로세스 삭제 버튼 이벤트
                    $('#remove-process')[0].addEventListener('click', () => {
                        $(`#process-panel-${cntProcess}`).remove();
                        --cntProcess;
                        if (cntProcess <= 1) {
                            $('#remove-process').remove();
                        }
                    });
                }

                $(`#process-panel-${cntProcess++}`).after(`
                    <div class="panel panel-default" id="process-panel-${cntProcess}">
                        <div class="panel-body">
                            <label for="process-${cntProcess}">P${cntProcess}</label>
                            <div class="form-inline" id="process-${cntProcess}">
                                <label for="arrival-${cntProcess}">도착 시간</label>
                                <input type="number" min="0" class="form-control" id="arrival-${cntProcess}" required>
                                <br />
                                <label for="burst-${cntProcess}">수행 시간</label>
                                <input type="number" min="1" class="form-control" id="burst-${cntProcess}" required>
                            </div>
                        </div>
                    </div>
                `);
            });

            // TODO: 실행  버튼 이벤트
            function run() {
                let technique = $('input[type=radio][name=technique]:checked').val();
                let delta = null;
                let arrivals = [null];  // P1 -> arrivals[1]
                let bursts = [null];

                for (let i = 1; i <= cntProcess; ++i) {
                    arrivals.push(parseInt($(`#arrival-${i}`).val()));
                    bursts.push(parseInt($(`#burst-${i}`).val()));
                }

                // TODO: 입력 값 유효성 검사

                if (isRunning) {
                    alert('이미 실행 중이에요.');
                    $('#btn-run').prop('disabled', true);
                    return;
                }
                else if (technique) {
                    $('.col-input').removeClass('col-md-offset-3');
                    setTimeout(() => {
                        document.getElementById('out-form').style.opacity = '1';
                    }, 500);
                }
                else {
                    alert('프로세스 기법을 선택하세요.');
                    technique.focus();
                    return;
                }

                // TODO: 유효성 검사 끝 / 함수 실행

                isRunning = true;
                $('#btn-run').prop('disabled', true);

                let waitings = [];
                let turnArounds = [];
                let pStates = [];

                switch (technique) {
                    case 'FCFS':
                        [waitings, turnArounds, pStates] = FCFS(cntProcess, arrivals, bursts);
                        break;
                    case 'RR':
                        // delta 입력 칸은 동적으로 생성됐으니 찾아야 해요
                        delta = parseInt($(document).find('input#delta').val());
                        [waitings, turnArounds, pStates] = RR(cntProcess, arrivals, bursts, delta);
                        break;
                    case 'SPN':
                        [waitings, turnArounds, pStates] = SPN(cntProcess, arrivals, bursts);
                        break;
                    case 'SRTN':
                        [waitings, turnArounds, pStates] = SRTN(cntProcess, arrivals, bursts);
                        break;
                    case 'HRRN':
                        [waitings, turnArounds, pStates] = HRRN(cntProcess, arrivals, bursts);
                        break;
                    case 'INFINITY GAUNTLET':
                        [waitings, turnArounds, pStates] = InfinityGauntlet(cntProcess, arrivals, bursts);
                        break;
                }

                // TODO: 함수 실행 끝 / 출력 시작

                // 배경 전환
                $('body').css('background-image', 'URL(https://ifh.cc/g/jkILS.png');
                $('body').css('background-size', '2500px 1500px');
                $('body').css('background-position', 'center');

                if (technique === 'RR') {
                    $('#out-title').html(`
                        ${technique} <span class="maincolor">(δ = ${delta})</span>
                    `);
                }
                else {
                    $('#out-title').html(`
                        ${technique}
                    `);
                }

                // 테이블, 시간 바, 간트 바 초기화

                $('#process-table').empty();
                $('#progress-body').empty();
                $('#progress-time').empty();
                $('#panel-process').empty();

                // 테이블 출력
                for (let i = 1; i <= cntProcess; ++i) {
                    $('#process-table').append(`
                        <tr>
                            <td>P${i}</td>
                            <td>${arrivals[i]}</td>
                            <td>${bursts[i]}</td>
                            <td>${waitings[i]}</td>
                            <td>${turnArounds[i]}</td>
                            <td>${(turnArounds[i]/bursts[i]).toFixed(2)}</td>
                        </tr>
                    `);

                    // 프로세스 진행 바 생성
                    $('#panel-process').append(`
                        <span>P${i}</span>
                        <div id="abc${i}" class="progress progress-slim">
                            <div class="progress-bar progress-bar-info progress-bar-striped active" role="progressbar" style="width: 0%">
                                 0%
                            </div>
                        </div>
                    `);
                }

                // TODO: 프로그레스 바 출력

                let colors = [null];
                setColors(colors, cntProcess);  // funcs.js

                let sum = 0;

                for (let i = 0; i < pStates.length; ++i) {
                    sum += pStates[i][2];
                }

                let Eachprocess = [null];
                for (let i = 1; i <= cntProcess; ++i) {
                    Eachprocess[i] = 0;
                }
                let timeArrive = 0;
                for (let i = 0; i < pStates.length; ++i) {
                    (function(i) {
                        setTimeout(() => {
                            let pIdx = pStates[i][0];
                            let timeStay = pStates[i][2];
                            let width = (timeStay / sum) * 100;  // %

                            // 도착 시간 표시 바
                                $('#progress-time').append(`
                                    <div class="progress-bar progress-bar-blank" id="progress-time"
                                        style="width: ${width}%; color: black;">
                                        <span class="content">
                                            <h5 align=left>${timeArrive}</h5>
                                        </span>
                                    </div>
                                `);

                            timeArrive += timeStay;

                            // 프로세서 진행 바
                            if (pIdx === null || pIdx === undefined) {
                                $('#progress-body').append(`
                                    <div class="progress-bar progress-bar-blank progress-bar-striped active"
                                        style ="width : ${width}%">
                                        <span class="content">
                                            <h5>Idle</h5>${timeStay}초
                                        </span>
                                    </div>
                                `);
                            } else {
                                if (technique == 'FCFS' || technique == 'SPN' || technique == 'HRRN') {
                                    $('#progress-body').append(`
                                        <div class="progress-bar progress-bar-striped active"
                                            style ="width : ${width}%; background-color: ${colors[pIdx]};">
                                            <span class="content">
                                                <h5>P${pIdx}</h5>${bursts[pIdx]}초
                                            </span>
                                        </div>
                                    `);
                                } else if (technique == 'RR' || technique == 'SRTN') {
                                    $('#progress-body').append(`
                                        <div class="progress-bar progress-bar-striped active"
                                             style ="width : ${width}%; background-color: ${colors[pIdx]};">
                                            <span class="content">
                                                <h5>P${pIdx}</h5>${timeStay}초 <span class="lightgray">/ ${bursts[pIdx]}초</span>
                                            </span>
                                        </div>
                                    `);
                                }
                            }

                            // 프로세스 각각 진행 바
                            width = (timeStay / bursts[pStates[i][0]]) * 100;
                            Eachprocess[pStates[i][0]] += width;
                            Printpercent =  Eachprocess[pStates[i][0]].toFixed(2);
                            $(`#abc${pStates[i][0]}`).find('div').css('width', `${Eachprocess[pStates[i][0]]}%`);
                            $(`#abc${pStates[i][0]}`).find('div').css('background-color', `${colors[pStates[i][0]]}`);
                            $(`#abc${pStates[i][0]}`).find('div').text(`${Printpercent}%`);
                        }, 1000 * i);  // 딜레이
                    }(i));  // 무명 함수 인자
                }

                setTimeout(() => {
                    isRunning = false;
                    $('#btn-run').prop('disabled', false);
                }, 1000 * pStates.length);
            }  // end of run()

            $(document).on('submit', '.form', function(e) {
                e.preventDefault();  // 새로고침 방지
                $.ajax({
                    success: function(html) {
                        run();  // required 필드 검사가 성공하면 실행
                    }
                });
            });
        });
    </script>
</div>

</body>

</html>
