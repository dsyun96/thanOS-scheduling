<!doctype html>
<html lang="ko">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="프로세스 스케줄러 시뮬레이터">
    <meta name="theme-color" content="#bb88ff">
    <title>thanOS 프로세스 스케줄러</title>

    <!-- jQuery 3.3.1 -->
    <script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
    <!-- Bootstrap 3.3.7 -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.0/js/bootstrap.min.js"></script>

    <link rel="stylesheet" href="css/main.css">

</head>

<body>

<div class="container">

    <div class="row">
        <!-- 1열: 입력 폼 -->
        <div class="col-md-6 col-md-offset-3 col-input">
            <div class="panel panel-default">
                <div class="panel-body">
                    <h1>thanOS</h1>
                    <h2>프로세스 스케줄러</h2>
                    <!--[if IE]>
                    <p class="center"><strong>오래된</strong> 브라우저를 사용하고 계시네요. 브라우저를 <a href="https://browsehappy.com/">업데이트</a>해 주세요.</p>
                    <![endif]-->
                </div>
            </div>
            <form class="form">
                <div class="panel panel-default">
                    <div class="panel-body">
                        <div class="form-group" id="group-technique">
                            <label class="radio control-label big">스케줄링 기법</label>
                            <div class="radio-inline">
                                <label>
                                    <input type="radio" name="technique" value="FCFS" required>
                                    <abbr title="First-Come First-Served">FCFS</abbr>
                                </label>
                            </div>
                            <div class="radio-inline">
                                <label>
                                    <input type="radio" name="technique" value="RR" required>
                                    <abbr title="Round Robin">RR</abbr>
                                </label>
                            </div>
                            <div class="radio-inline">
                                <label>
                                    <input type="radio" name="technique" value="SPN" required>
                                    <abbr title="Shortest Process Next">SPN</abbr>
                                </label>
                            </div>
                            <div class="radio-inline">
                                <label>
                                    <input type="radio" name="technique" value="SRTN" required>
                                    <abbr title="Shortest Remaining Time Next">SRTN</abbr>
                                </label>
                            </div>
                            <div class="radio-inline">
                                <label>
                                    <input type="radio" name="technique" value="HRRN" required>
                                    <abbr title="Highest Response Ratio Next">HRRN</abbr>
                                </label>
                            </div>
                            <div class="radio-inline">
                                <label>
                                    <input type="radio" name="technique" value="???" required>
                                    <abbr class="sans" title="다뿌셔">INFINITY GAUNTLET</abbr>
                                </label>
                            </div>
                        </div>
                        <!-- RR 선택 시 이 위치에 시간 단위 입력 칸 생성 -->
                        <div class="form-group">
                            <label class="big">프로세스</label>
                            <div class="panel panel-default" id="process-panel-1">
                                <div class="panel-body">
                                    <label for="process-1">P1</label>
                                    <div class="form-inline" id="process-1">
                                        <label for="arrival-1">도착 시간</label>
                                        <input type="number" min="0" class="form-control" id="arrival-1" required>
                                        <br />
                                        <label for="burst-1">수행 시간</label>
                                        <input type="number" min="1" class="form-control" id="burst-1" required>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="form-group right">
                            <!-- 프로세스 추가 시 이 위치에 삭제 버튼 생성 -->
                            <button type="button" class="btn btn-primary" id="add-process"><span class="glyphicon glyphicon-plus"></span> 추가</button>
                        </div>
                    </div>
                </div>

                <div class="panel panel-default">
                    <div class="panel-body">
                        <button type="submit" class="big btn btn-primary btn-block" id="run"><span class="glyphicon glyphicon-play"></span> 실행</button>
                    </div>
                </div>
            </form>
        </div>

        <!-- 2열: 출력 파트 -->
        <div class="col-md-6 col-output" id="out-form" style="opacity: 0;">
            <div class="panel panel-default">
                <div class="panel-body">
                    <h2>프로세서가 열일중입니다...</h2>
                    <div id="output-subtitle"></div>

                    <div class="progress" style="height:50px">
                        <div class="progress-bar progress-bar-blank" role="progressbar" style="width: 15%">
                            <h5>Idle</h5>
                        </div>
                        <div class="progress-bar progress-bar-info" role="progressbar" style="width: 15%">
                            <h5>P1</h5>15 <span class="lightgray">/ 15</span>
                        </div>
                        <div class="progress-bar progress-bar-success" role="progressbar" style="width: 10%">
                            <h5>P3</h5>10 <span class="lightgray">/ 25</span>
                        </div>
                        <div class="progress-bar progress-bar-warning" role="progressbar" style="width: 25%">
                            <h5>P2</h5>25 <span class="lightgray">/ 50</span>
                        </div>
                        <div class="progress-bar progress-bar-danger progress-bar-striped active" role="progressbar" style="width:15%">
                            <h5>P4</h5>15 <span class="lightgray">/ 65</span>
                        </div>
                    </div>
                </div>

                <table class="table table-bordered table-hover">
                    <tr class="active">
                        <th>프로세스</th><th>AT</th><th>BT</th><th>WT</th><th>TT</th><th>NTT</th>
                    </tr>
                    <tbody id="process-table"></tbody>
                </table>
            </div>

            <div class="panel panel-default">
                <div class="panel-body">
                    <h3>프로세스 1</h3>
                    <div class="progress">
                        <div class="progress-bar progress-bar-info" role="progressbar" style="width: 15%">
                            15%
                        </div>
                    </div>
                </div>
            </div>

            <div class="panel panel-default">
                <div class="panel-body">
                    <h3>프로세스 4</h3>
                    <div class="progress">
                        <div class="progress-bar progress-bar-danger progress-bar-striped active" role="progressbar" style="width: 55%">
                            55%
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap 3.3.7 -->
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>

    <script type="text/javascript">
        $(function() {  // 페이지 로드 완료 후 스크립트 로드

            let isRR = false;
            let cntProcess = 1;

            // 프로세스 기법 라디오 버튼 이벤트
            $('input[type=radio][name=technique]').change(() => {
                let technique = $('input[type=radio][name=technique]:checked').val();
                if (technique === 'RR' && !isRR) {
                    isRR = true;
                    $('#group-technique').after(`
                        <div class="form-inline" id="delta">
                            <label for="delta">δ (Time Quantum)</label>
                            <input type="number" min="1" class="form-control" id="delta" required>
                        </div>
                    `);
                }
                else if (isRR) {
                    isRR = false;
                    $('#delta').remove();
                    $('#quantum').remove();
                }
            });

            // 프로세스 추가 버튼 이벤트
            $('#add-process').click(() => {
                if (cntProcess === 1) {
                    $('#add-process').before(`
          <button type="button" class="btn btn-primary" id="remove-process"><span class="glyphicon glyphicon-minus"></span> 삭제</button>
        `);
                    // 프로세스 삭제 버튼 이벤트
                    $('#remove-process')[0].addEventListener('click', () => {
                        $(`#process-panel-${cntProcess}`).remove();
                        --cntProcess;
                        if (cntProcess <= 1) {
                            $('#remove-process').remove();
                        }
                    });
                }
                $(`#process-panel-${cntProcess++}`).after(`
                    <div class="panel panel-default" id="process-panel-${cntProcess}">
                        <div class="panel-body">
                            <label for="process-${cntProcess}">P${cntProcess}</label>
                            <div class="form-inline" id="process-${cntProcess}">
                                <label for="arrival-${cntProcess}">도착 시간</label>
                                <input type="number" min="0" class="form-control" id="arrival-${cntProcess}" required>
                                <br />
                                <label for="burst-${cntProcess}">수행 시간</label>
                                <input type="number" min="1" class="form-control" id="burst-${cntProcess}" required>
                            </div>
                        </div>
                    </div>
                `);
            });

            // 실행  버튼 이벤트
            function run() {
                let technique = $('input[type=radio][name=technique]:checked').val();
                let delta = null;
                let arrivals = [];
                let bursts = [];

                for (let i = 1; i <= cntProcess; ++i) {
                    arrivals.push($(`#arrival-${i}`).val());
                    bursts.push($(`#burst-${i}`).val());
                }

                //TODO: 입력 값 유효성 검사

                if (technique) {
                    $('.col-input').removeClass('col-md-offset-3');
                    setTimeout(() => {
                        document.getElementById('out-form').style.opacity = '1';
                    }, 500);
                }
                else {
                    alert('프로세스 기법을 선택하세요.');
                    technique.focus();
                }

                // 유효성 검사 끝 / 함수 실행 시작

                let waitings = [];
                let turnArounds = [];
                let pStates = [];
                $.getScript("js/execute.js", function() {
                    [waitings, turnArounds, pStates] = FCFS(cntProcess, arrivals, bursts);
                });
                console.log(waitings);
                console.log(turnArounds);
                console.log(pStates);

                // 함수 실행 끝 / 출력 시작

                // 배경 전환
                $('body').css('background-image', 'url(https://www.pixel4k.com/wp-content/uploads/2018/11/thanos-4k_1543619966.jpg)');
                $('body').css('background-size', '2500px 1500px');
                $('body').css('background-position', 'center');

                if (technique === 'RR') {
                    // delta 입력 칸은 동적으로 생성됐으니 찾아야 해요
                    delta = $(document).find('input#delta').val();

                    $('#output-subtitle').html(`
                        <h4>${technique} <span class="maincolor">(δ = ${delta})</span></h4>
                    `);
                }
                else {
                    $('#output-subtitle').html(`
                            <h4>${technique}</h4>
                        `);
                }

                $('#process-table').empty();

                for (let i = 1; i <= cntProcess; ++i) {
                    // 표에 프로세스 데이터 추가
                    $('#process-table').append(`
                        <tr><td>P${i}</td><td>${arrivals[i-1]}</td><td>${bursts[i-1]}</td><td>nil</td><td>nil</td><td>nil</td></tr>
                    `);
                }
            }

            $(document).on('submit', '.form', function(e) {
                e.preventDefault();  // 새로고침 방지
                $.ajax({
                    success: function(html) {
                        run();  // required 필드 검사가 성공하면 실행
                    }
                });
            });
        });
    </script>
</div>

</body>

</html>
